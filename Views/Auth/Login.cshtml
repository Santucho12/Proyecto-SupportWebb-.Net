@model SupportWeb.Models.ViewModels.LoginViewModel
@{
    ViewData["Title"] = "Iniciar Sesión";
    Layout = "_AuthLayout";
}

<h2 class="text-center mb-4">Iniciar Sesión</h2>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>@Model.ErrorMessage
    </div>
}

@if (!string.IsNullOrEmpty(ViewBag.SuccessMessage))
{
    <div class="alert alert-success" role="alert">
        <i class="bi bi-check-circle me-2"></i>@ViewBag.SuccessMessage
    </div>
}

<form asp-action="Login" method="post">
    @if (ViewBag.Token != null)
    {
        <script>
            localStorage.setItem('jwtToken', '@ViewBag.Token');
            window.location.href = '/';
        </script>
    }
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[asp-action="Login"]');
    if (!form) return;
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = form.querySelector('[name="Email"]').value;
        const password = form.querySelector('[name="Password"]').value;
        const data = {
            correoElectronico: email,
            contrasena: password
        };
        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok && result.token) {
                localStorage.setItem('jwtToken', result.token);
                window.location.href = '/'; // Redirige al dashboard o página principal
            } else {
                alert(result.message || 'Credenciales inválidas');
            }
        } catch (err) {
            alert('Error de red o servidor');
        }
    });
});
</script>
    <input type="hidden" asp-for="ReturnUrl" />

    <div class="form-floating mb-3">
        <input asp-for="Email" class="form-control" placeholder="correo@ejemplo.com" autocomplete="email" required />
        <label asp-for="Email"></label>
        <span asp-validation-for="Email" class="text-danger"></span>
    </div>

    <div class="form-floating mb-3">
        <input asp-for="Password" class="form-control" placeholder="Contraseña" autocomplete="current-password" required />
        <label asp-for="Password"></label>
        <span asp-validation-for="Password" class="text-danger"></span>
    </div>

    <div class="form-check mb-3">
        <input asp-for="RememberMe" class="form-check-input" />
        <label asp-for="RememberMe" class="form-check-label">
            Recordarme
        </label>
    </div>

    <div class="d-grid gap-2 mb-3">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-box-arrow-in-right me-2"></i>Iniciar Sesión
        </button>
    </div>

    <div class="text-center">
        <p class="mb-0">¿No tienes una cuenta?</p>
        <a asp-action="Register" class="text-primary text-decoration-none fw-semibold">
            Regístrate aquí
        </a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        console.log('Login page loaded');

        // Focus en el primer campo
        document.querySelector('#Email').focus();

        // Debug del formulario
        document.querySelector('form').addEventListener('submit', function(e) {
            console.log('Form submit event triggered');
            console.log('Email:', document.querySelector('#Email').value);
            console.log('Password length:', document.querySelector('#Password').value.length);

            // Verificar si hay errores de validación
            const form = this;
            if (!form.checkValidity()) {
                console.log('Form validation failed');
                e.preventDefault();
                return false;
            }

            console.log('Form is valid, submitting...');
        });

        // Debug del botón
        document.querySelector('.btn-primary').addEventListener('click', function(e) {
            console.log('Submit button clicked');
        });

        // Efecto hover en el botón
        document.querySelector('.btn-primary').addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });

        document.querySelector('.btn-primary').addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    </script>
}
